/*!
 * phaser3-nineslice - version 1.0.0
 * NineSlice plugin for Phaser 3
 *
 * Works in browser directly
 * Released under MIT License
 */

(function (global) {

  class NineSlice extends Phaser.GameObjects.RenderTexture {
    constructor(scene, x, y, key, width, height, config) {
      super(scene, x, y, width, height);

      this.scene = scene;
      this.key = key;
      this.width = width;
      this.height = height;

      this.margins = Object.assign({
        top: 20,
        left: 20,
        right: 20,
        bottom: 20
      }, config);

      this.baseFrame = scene.textures.get(key).getSourceImage();

      this.renderNineSlice();

      scene.add.existing(this);
    }

    renderNineSlice() {
      this.clear();

      const tex = this.scene.textures.get(this.key).getSourceImage();
      const texW = tex.width;
      const texH = tex.height;

      const { top, left, right, bottom } = this.margins;

      const xs = [0, left, texW - right, texW];
      const ys = [0, top, texH - bottom, texH];

      const dx = [0, left, this.width - right, this.width];
      const dy = [0, top, this.height - bottom, this.height];

      for (let yi = 0; yi < 3; yi++) {
        for (let xi = 0; xi < 3; xi++) {
          const sx = xs[xi];
          const sy = ys[yi];
          const sw = xs[xi + 1] - xs[xi];
          const sh = ys[yi + 1] - ys[yi];

          const dxPos = dx[xi];
          const dyPos = dy[yi];
          const dw = dx[xi + 1] - dx[xi];
          const dh = dy[yi + 1] - dy[yi];

          this.drawFrame(this.key, null, dxPos, dyPos, dw, dh, sx, sy, sw, sh);
        }
      }
    }

    resize(width, height) {
      this.width = width;
      this.height = height;
      this.renderNineSlice();
    }
  }

  class NineSlicePlugin extends Phaser.Plugins.BasePlugin {
    constructor(pluginManager) {
      super(pluginManager);

      pluginManager.registerGameObject('nineSlice', this.createNineSlice);
    }

    createNineSlice(x, y, key, width, height, config) {
      return new NineSlice(this.scene, x, y, key, width, height, config);
    }
  }

  // 挂到全局
  global.NineSlicePlugin = NineSlicePlugin;

})(this);